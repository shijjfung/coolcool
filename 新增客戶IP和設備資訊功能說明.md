# 新增客戶 IP 和設備資訊功能說明

## ✅ 已完成的功能

現在系統會自動記錄並顯示：
1. ✅ **客戶 IP 地址**：記錄客戶下單時的 IP 地址
2. ✅ **設備類型**：自動判斷是手機還是電腦
3. ✅ **提交時間**：按照時間順序排列（從早到晚）

## 📊 功能展示

### 管理頁面顯示

在表單詳情頁面（`/admin/forms/[id]`），現在會顯示：

| 提交時間 | 客戶姓名 | 客戶電話 | 訂單內容 | 設備類型 | 客戶 IP |
|---------|---------|---------|---------|---------|---------|
| 2025/01/20 14:30:25 | 張三 | 0912345678 | 商品A x5 | 📱 手機 | 192.168.1.100 |
| 2025/01/20 14:35:10 | 李四 | 0987654321 | 商品B x3 | 💻 電腦 | 203.0.113.45 |

### 設備類型判斷

系統會自動判斷：
- **📱 手機**：如果 User-Agent 包含 mobile、android、iphone、ipad
- **💻 電腦**：其他情況

## 🔧 資料庫更新

### 如果使用 Supabase

**需要執行 SQL 腳本添加新欄位**：

1. **前往 Supabase Dashboard**
   - 網址：https://supabase.com/dashboard
   - 登入您的帳號

2. **選擇您的專案**

3. **點擊左側選單的 "SQL Editor"**

4. **執行 SQL 腳本**：
   - 打開 `supabase-add-order-fields.sql` 檔案
   - 複製內容到 SQL Editor
   - 點擊 "Run" 執行

**SQL 腳本內容**：
```sql
-- 添加 client_ip 欄位（如果不存在）
ALTER TABLE orders 
ADD COLUMN IF NOT EXISTS client_ip TEXT;

-- 添加 user_agent 欄位（如果不存在）
ALTER TABLE orders 
ADD COLUMN IF NOT EXISTS user_agent TEXT;
```

### 如果使用 SQLite

**不需要手動操作**：
- 系統會自動檢測並添加新欄位
- 下次啟動時會自動更新資料庫結構

## 📝 技術細節

### 1. IP 地址取得方式

系統會依序嘗試以下方式取得客戶 IP：
1. `X-Forwarded-For` header（如果使用代理伺服器）
2. `X-Real-IP` header
3. `req.socket.remoteAddress`（直接連線）
4. `unknown`（如果都無法取得）

### 2. User-Agent 解析

系統會檢查 User-Agent 字串，判斷設備類型：
- **手機**：包含 `mobile`、`android`、`iphone`、`ipad`
- **電腦**：其他情況

### 3. 時間排序

訂單現在按照 `created_at` **升序排列**（從早到晚）：
- 最早的訂單在最上面
- 最新的訂單在最下面

## 🎯 使用說明

### 查看客戶資訊

1. **前往管理頁面**
   - 登入管理後台
   - 選擇要查看的表單

2. **查看訂單列表**
   - 點擊表單卡片
   - 或點擊「查看報表」按鈕

3. **查看詳細資訊**
   - 提交時間：顯示完整的日期和時間
   - 設備類型：顯示 📱 手機 或 💻 電腦
   - 客戶 IP：顯示 IP 地址（使用等寬字體）

### 注意事項

1. **舊訂單**：
   - 在更新資料庫之前建立的訂單，IP 和設備資訊會顯示為 `-`
   - 這是正常的，因為當時還沒有記錄這些資訊

2. **新訂單**：
   - 更新資料庫後，所有新訂單都會自動記錄 IP 和設備資訊

3. **IP 地址**：
   - 如果客戶使用 VPN 或代理，IP 可能不是真實位置
   - 如果部署在 Vercel 等平台，IP 可能顯示為內部 IP

## 🔄 更新步驟總結

### 步驟 1：更新 Supabase 資料庫（如果使用 Supabase）

1. 前往 Supabase Dashboard
2. 執行 `supabase-add-order-fields.sql` 中的 SQL

### 步驟 2：重新啟動應用程式

```bash
# 停止目前的伺服器（如果正在運行）
# 按 Ctrl+C

# 重新啟動
npm run dev
```

### 步驟 3：測試功能

1. 創建一個測試表單
2. 用手機和電腦分別填寫訂單
3. 查看管理頁面，確認顯示正確

## ✅ 完成！

現在您可以：
- ✅ 查看每個訂單的提交時間（按順序排列）
- ✅ 知道客戶是用手機還是電腦下單
- ✅ 查看客戶的 IP 地址

所有新訂單都會自動記錄這些資訊！

