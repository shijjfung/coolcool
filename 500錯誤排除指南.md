# 500 Internal Server Error 排除指南

## 問題說明

500 錯誤表示：
- ✅ 請求已經到達伺服器（網址正確）
- ✅ 認證可能通過（CRON_SECRET 可能正確）
- ❌ 但伺服器內部發生錯誤

## 步驟 1：檢查 Vercel Function Logs

### 查看詳細錯誤訊息

1. 前往 Vercel Dashboard：https://vercel.com/dashboard
2. 點擊您的專案：**coolcool**
3. 點擊 **Functions** 標籤
4. 找到 `/api/cron/facebook-monitor` 或 `/api/facebook/scan-comments`
5. 點擊進入，查看 **Logs** 或 **執行記錄**
6. 查看最新的錯誤訊息

### 常見錯誤類型

#### 錯誤 1：資料庫連接失敗
```
資料庫初始化失敗
ensureDatabaseInitialized is not a function
```
**解決**：檢查資料庫環境變數是否正確設定

#### 錯誤 2：Facebook Access Token 問題
```
缺少 Facebook Access Token
無法取得 Facebook 留言
```
**解決**：檢查 `FACEBOOK_ACCESS_TOKEN` 是否設定

#### 錯誤 3：環境變數未設定
```
process.env.XXX is undefined
```
**解決**：檢查相關環境變數是否已設定

## 步驟 2：檢查必要的環境變數

### 在 Vercel Dashboard 確認

前往 Vercel Dashboard > 專案 > Settings > Environment Variables，確認以下變數已設定：

#### 必須的環境變數：
- [ ] `CRON_SECRET`（您已經設定了）
- [ ] `FACEBOOK_ACCESS_TOKEN`（Facebook API Token）
- [ ] `DATABASE_TYPE`（資料庫類型：`supabase` 或 `sqlite`）

#### 如果使用 Supabase：
- [ ] `SUPABASE_URL`
- [ ] `SUPABASE_SERVICE_ROLE_KEY`
- [ ] `NEXT_PUBLIC_SUPABASE_URL`
- [ ] `NEXT_PUBLIC_SUPABASE_ANON_KEY`

#### 如果使用 SQLite：
- [ ] SQLite 相關設定（通常不需要額外環境變數）

## 步驟 3：檢查 API 端點是否正確

### 測試 API 端點

在瀏覽器中打開：
```
https://coolcool-ten.vercel.app/api/cron/facebook-monitor
```

**預期結果**：
- 如果沒有 Authorization header：應該返回 401 Unauthorized
- 如果有正確的 header：可能返回 500（因為缺少其他環境變數）

### 測試 Facebook 掃描 API

在瀏覽器中打開：
```
https://coolcool-ten.vercel.app/api/facebook/scan-comments
```

**預期結果**：
- 應該返回 JSON 回應（可能是錯誤訊息，但至少不是 500）

## 步驟 4：常見問題和解決方案

### 問題 1：資料庫未初始化

**錯誤訊息**：
```
資料庫初始化失敗
ensureDatabaseInitialized is not a function
```

**解決方案**：
1. 檢查 `DATABASE_TYPE` 環境變數是否正確設定
2. 如果使用 Supabase，確認所有 Supabase 環境變數都已設定
3. 重新部署 Vercel

### 問題 2：Facebook Access Token 未設定

**錯誤訊息**：
```
缺少 Facebook Access Token
```

**解決方案**：
1. 前往 Vercel Dashboard > Environment Variables
2. 確認 `FACEBOOK_ACCESS_TOKEN` 已設定
3. 如果沒有，請設定並重新部署

### 問題 3：API 內部邏輯錯誤

**可能原因**：
- 程式碼錯誤
- 資料格式問題
- 外部 API 呼叫失敗

**解決方案**：
1. 查看 Vercel Function Logs 的詳細錯誤訊息
2. 檢查是否有 TypeScript 編譯錯誤
3. 確認所有依賴都已正確安裝

## 步驟 5：重新部署

如果修改了環境變數：

1. 前往 Vercel Dashboard > Deployments
2. 點擊最新的部署記錄
3. 點擊右上角的 "..." 選單
4. 選擇 "Redeploy"
5. 等待部署完成

## 步驟 6：詳細診斷

### 檢查清單

請確認以下項目：

1. **Vercel Function Logs**：
   - [ ] 已查看最新的錯誤訊息
   - [ ] 已複製錯誤訊息

2. **環境變數**：
   - [ ] `CRON_SECRET` 已設定
   - [ ] `FACEBOOK_ACCESS_TOKEN` 已設定
   - [ ] `DATABASE_TYPE` 已設定
   - [ ] 如果使用 Supabase，所有 Supabase 變數都已設定

3. **API 端點**：
   - [ ] `/api/cron/facebook-monitor` 存在
   - [ ] `/api/facebook/scan-comments` 存在

4. **部署狀態**：
   - [ ] 最新部署狀態為 Ready（綠色）
   - [ ] 沒有編譯錯誤

## 請提供以下資訊

為了更準確地診斷問題，請提供：

1. **Vercel Function Logs 中的錯誤訊息**（完整錯誤訊息）
2. **已設定的環境變數列表**（不需要提供實際值，只需要知道哪些已設定）
3. **使用的資料庫類型**（Supabase 還是 SQLite）

這樣我可以提供更精確的解決方案。

