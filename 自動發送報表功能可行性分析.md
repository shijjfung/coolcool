# 自動發送報表功能可行性分析

## 📊 目前的功能狀態

### ✅ 已經實現的功能

1. **自動檢查截止日期**
   - 系統可以檢查哪些表單已到達截止日期
   - API：`/api/reports/auto-generate`

2. **自動生成報表**
   - 當截止日期到達時，可以自動生成 CSV 報表
   - 報表內容包含所有訂單資料

3. **自動保存到本地資料夾**
   - 如果設定了「報表輸出資料夾」，報表會自動保存
   - 設定位置：管理頁面 → 系統設定

4. **前端自動檢查**
   - 管理頁面每 30 秒自動檢查一次是否有需要生成報表的表單
   - 但**只在管理頁面打開時才會檢查**

### ❌ 目前缺少的功能

1. **自動發送郵件**
   - 沒有郵件發送功能
   - 沒有相關的套件（如 nodemailer）

2. **自動發送手機訊息**
   - 沒有簡訊發送功能
   - 沒有 LINE Notify 整合
   - 沒有 WhatsApp 自動發送

3. **真正的定時任務**
   - 目前只在管理頁面打開時才會檢查
   - 如果管理頁面關閉，就不會自動檢查
   - 沒有後端定時任務（cron job）

## 🎯 能否達成？

### ✅ **可以達成！** 但需要以下技術：

## 📧 方案 1：自動發送郵件

### 技術選項

#### 選項 A：使用 Resend（推薦，免費額度充足）
- **免費額度**：每月 3,000 封郵件
- **優點**：
  - 免費額度充足
  - 設定簡單
  - 支援附件（可以附加 CSV 報表）
- **缺點**：需要註冊帳號

#### 選項 B：使用 SendGrid
- **免費額度**：每月 100 封郵件
- **優點**：穩定可靠
- **缺點**：免費額度較少

#### 選項 C：使用 Gmail SMTP
- **免費額度**：無限制（但有限制）
- **優點**：不需要註冊新服務
- **缺點**：
  - 需要設定「應用程式密碼」
  - 每天有發送限制（約 500 封）
  - 安全性較低

### 實現方式

```typescript
// 需要安裝：npm install nodemailer 或 @resend/node
// 在生成報表後，自動發送郵件
await sendEmail({
  to: 'your-email@example.com',
  subject: `報表已生成：${formName}`,
  text: `表單「${formName}」的報表已生成，共 ${orders.length} 筆訂單。`,
  attachments: [{
    filename: reportFileName,
    content: csvContent
  }]
});
```

## 📱 方案 2：自動發送手機訊息

### 技術選項

#### 選項 A：LINE Notify（推薦，免費）
- **免費額度**：無限制
- **優點**：
  - 完全免費
  - 設定簡單
  - 可以發送文字和圖片
- **缺點**：
  - 只能發送通知，不能發送檔案
  - 需要用戶先加入 LINE Notify

#### 選項 B：Twilio（付費）
- **費用**：約 $0.0075/則簡訊（台灣）
- **優點**：
  - 可以發送簡訊到任何手機號碼
  - 可以發送檔案連結
- **缺點**：需要付費

#### 選項 C：台灣簡訊服務（付費）
- **費用**：約 $0.5-1/則簡訊
- **優點**：直接發送到手機
- **缺點**：費用較高

### 實現方式

```typescript
// LINE Notify 範例
await sendLineNotify({
  token: 'YOUR_LINE_NOTIFY_TOKEN',
  message: `📊 報表已生成：${formName}\n共 ${orders.length} 筆訂單\n下載連結：${downloadUrl}`
});

// Twilio 簡訊範例
await sendSMS({
  to: '+886912345678',
  message: `報表已生成：${formName}，共 ${orders.length} 筆訂單。下載：${downloadUrl}`
});
```

## ⏰ 方案 3：定時任務（Cron Job）

### 技術選項

#### 選項 A：Vercel Cron Jobs（推薦，如果部署到 Vercel）
- **免費額度**：有限制，但通常足夠
- **優點**：
  - 如果部署到 Vercel，可以直接使用
  - 設定簡單
- **缺點**：
  - 免費版有限制（例如：每天最多執行次數）
  - 只能部署到 Vercel

#### 選項 B：外部 Cron 服務（免費）
- **服務**：cron-job.org、EasyCron
- **優點**：
  - 完全免費
  - 可以設定任何頻率
  - 不依賴部署平台
- **缺點**：
  - 需要公開 API 端點
  - 需要設定認證（API Key）

#### 選項 C：Supabase Edge Functions + Cron
- **優點**：如果使用 Supabase，可以直接使用
- **缺點**：需要學習 Supabase Functions

### 實現方式

```typescript
// Vercel Cron Jobs（vercel.json）
{
  "crons": [{
    "path": "/api/reports/auto-generate",
    "schedule": "*/5 * * * *"  // 每 5 分鐘執行一次
  }]
}

// 或使用外部服務定期呼叫
// https://your-app.vercel.app/api/reports/auto-generate
```

## 🎯 完整實現方案

### 推薦組合（免費方案）

1. **定時任務**：使用外部 Cron 服務（如 cron-job.org）
   - 每 5-10 分鐘檢查一次
   - 呼叫 `/api/reports/auto-generate` API

2. **郵件發送**：使用 Resend
   - 免費額度：每月 3,000 封
   - 可以附加 CSV 報表檔案

3. **手機通知**：使用 LINE Notify
   - 完全免費
   - 發送通知訊息（包含下載連結）

### 實現流程

```
1. 定時任務（每 5 分鐘）
   ↓
2. 呼叫 /api/reports/auto-generate
   ↓
3. 檢查是否有到期的表單
   ↓
4. 生成報表（CSV）
   ↓
5. 同時執行：
   ├─ 保存到本地資料夾（如果設定了）
   ├─ 發送郵件（附加 CSV 檔案）
   └─ 發送 LINE Notify（包含下載連結）
```

## 💰 成本分析

### 免費方案（推薦）

- **定時任務**：cron-job.org（免費）
- **郵件發送**：Resend（每月 3,000 封免費）
- **手機通知**：LINE Notify（完全免費）
- **總成本**：**$0**

### 付費方案（如果需要更多功能）

- **定時任務**：Vercel Cron（免費版通常足夠）
- **郵件發送**：Resend Pro（$20/月，無限郵件）
- **簡訊發送**：Twilio（約 $0.0075/則）
- **總成本**：視使用量而定

## ✅ 總結

### 能否達成？

**✅ 完全可以達成！**

### 需要什麼？

1. **郵件發送功能**：安裝 nodemailer 或使用 Resend
2. **手機通知功能**：整合 LINE Notify 或 Twilio
3. **定時任務**：使用 Vercel Cron 或外部 Cron 服務

### 實現難度？

- **郵件發送**：⭐⭐（中等，需要設定 API Key）
- **LINE Notify**：⭐⭐（中等，需要取得 Token）
- **定時任務**：⭐⭐⭐（較簡單，主要是設定）

### 建議

**先實現郵件發送**，因為：
- 最實用（可以附加 CSV 檔案）
- 設定相對簡單
- 免費額度充足

**然後添加 LINE Notify**，因為：
- 可以即時通知
- 完全免費
- 設定簡單

**最後設定定時任務**，讓系統完全自動化。

## 🚀 下一步

如果您想要實現這個功能，我可以：

1. **添加郵件發送功能**（使用 Resend）
2. **添加 LINE Notify 整合**
3. **設定定時任務**（使用外部 Cron 服務或 Vercel Cron）

需要我開始實現嗎？

