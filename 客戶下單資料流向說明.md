# å®¢æˆ¶ä¸‹å–®è³‡æ–™æµå‘èªªæ˜

## âœ… å¿«é€Ÿå›ç­”

**æ˜¯çš„ï¼** å¦‚æœæ‚¨çš„ç³»çµ±è¨­å®šç‚ºä½¿ç”¨ Supabaseï¼Œå®¢æˆ¶ä¸‹å–®å¾Œçš„è³‡æ–™**æœƒç›´æ¥å¯«å…¥é›²ç«¯è³‡æ–™åº«ï¼ˆSupabaseï¼‰**ã€‚

## ğŸ“Š è³‡æ–™æµå‘åœ–

### å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ¶æ‰‹æ©Ÿ/é›»è…¦  â”‚
â”‚  (ç€è¦½å™¨)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1. å¡«å¯«è¡¨å–®
         â”‚ 2. é»æ“Šã€Œé€å‡ºã€
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Next.js API   â”‚
â”‚  /api/orders/create â”‚
â”‚  (æ‚¨çš„æ‡‰ç”¨ç¨‹å¼)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 3. é©—è­‰è¡¨å–®æ˜¯å¦å­˜åœ¨
         â”‚ 4. æª¢æŸ¥æ˜¯å¦è¶…éæˆªæ­¢æ™‚é–“
         â”‚ 5. æº–å‚™è¨‚å–®è³‡æ–™
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è³‡æ–™åº«å±¤      â”‚
â”‚  (è‡ªå‹•é¸æ“‡)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabaseâ”‚ â”‚ SQLite   â”‚
â”‚ (é›²ç«¯)  â”‚ â”‚ (æœ¬åœ°)   â”‚
â”‚         â”‚ â”‚          â”‚
â”‚ âœ… è³‡æ–™ â”‚ â”‚ âŒ ä¸ä½¿ç”¨ â”‚
â”‚ å¯«å…¥é€™è£¡â”‚ â”‚ (å¦‚æœè¨­å®šâ”‚
â”‚         â”‚ â”‚  Supabase)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” æŠ€è¡“ç´°ç¯€

### 1. ç³»çµ±å¦‚ä½•é¸æ“‡è³‡æ–™åº«ï¼Ÿ

ç³»çµ±æœƒæ ¹æ“š `.env.local` æª”æ¡ˆä¸­çš„è¨­å®šè‡ªå‹•é¸æ“‡ï¼š

```env
# å¦‚æœè¨­å®šç‚º supabase
DATABASE_TYPE=supabase

# ç³»çµ±æœƒä½¿ç”¨ Supabaseï¼ˆé›²ç«¯è³‡æ–™åº«ï¼‰
```

```env
# å¦‚æœè¨­å®šç‚º sqliteï¼ˆæˆ–æ²’æœ‰è¨­å®šï¼‰
DATABASE_TYPE=sqlite

# ç³»çµ±æœƒä½¿ç”¨ SQLiteï¼ˆæœ¬åœ°è³‡æ–™åº«ï¼‰
```

### 2. è¨‚å–®å‰µå»ºæµç¨‹

#### æ­¥é©Ÿ 1ï¼šå®¢æˆ¶å¡«å¯«è¡¨å–®

```typescript
// å®¢æˆ¶åœ¨ç€è¦½å™¨ä¸­å¡«å¯«è¡¨å–®
POST /api/orders/create
{
  formToken: "abc123...",      // è¡¨å–®ä»£ç¢¼
  orderData: {                 // è¨‚å–®è³‡æ–™
    product: "å•†å“A",
    quantity: 5,
    // ... å…¶ä»–æ¬„ä½
  },
  customerName: "å¼µä¸‰",
  customerPhone: "0912345678"
}
```

#### æ­¥é©Ÿ 2ï¼šAPI è™•ç†

```typescript
// pages/api/orders/create.ts
export default async function handler(req, res) {
  // 1. æª¢æŸ¥è¡¨å–®æ˜¯å¦å­˜åœ¨
  const form = await getFormByToken(formToken);
  
  // 2. æª¢æŸ¥æ˜¯å¦è¶…éæˆªæ­¢æ™‚é–“
  if (now > deadline) {
    return res.status(400).json({ error: 'è¡¨å–®å·²è¶…éæˆªæ­¢æ™‚é–“' });
  }
  
  // 3. å‰µå»ºè¨‚å–®
  const orderToken = await createOrder(
    form.id,           // è¡¨å–® ID
    orderData,         // è¨‚å–®è³‡æ–™
    customerName,     // å®¢æˆ¶å§“å
    customerPhone     // å®¢æˆ¶é›»è©±
  );
  
  return res.status(200).json({ success: true, orderToken });
}
```

#### æ­¥é©Ÿ 3ï¼šè³‡æ–™åº«å¯«å…¥

ç³»çµ±æœƒæ ¹æ“š `DATABASE_TYPE` è‡ªå‹•é¸æ“‡ï¼š

**å¦‚æœä½¿ç”¨ Supabase**ï¼š
```typescript
// lib/db-supabase.ts
export async function createOrder(
  formId: number,
  orderData: Record<string, any>,
  customerName?: string,
  customerPhone?: string
): Promise<string> {
  // ç›´æ¥å¯«å…¥ Supabase é›²ç«¯è³‡æ–™åº«
  const { data, error } = await getSupabase()
    .from('orders')
    .insert({
      form_id: formId,
      customer_name: customerName,
      customer_phone: customerPhone,
      order_data: orderData,
      order_token: generateToken()
    });
  
  // è³‡æ–™å·²ç¶“åœ¨é›²ç«¯äº†ï¼
  return orderToken;
}
```

**å¦‚æœä½¿ç”¨ SQLite**ï¼š
```typescript
// lib/db.ts
async function createOrderSQLite(...) {
  // å¯«å…¥æœ¬åœ° orders.db æª”æ¡ˆ
  await dbRun(
    'INSERT INTO orders (form_id, ...) VALUES (?, ...)',
    [formId, ...]
  );
}
```

## âœ… ç¢ºèªæ‚¨çš„è¨­å®š

### æª¢æŸ¥æ˜¯å¦ä½¿ç”¨ Supabase

1. **æª¢æŸ¥ `.env.local` æª”æ¡ˆ**ï¼š
   ```env
   DATABASE_TYPE=supabase
   ```

2. **æª¢æŸ¥ Supabase è¨­å®š**ï¼š
   ```env
   NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
   NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
   SUPABASE_SERVICE_ROLE_KEY=eyJ...
   ```

3. **ç¢ºèª Supabase è³‡æ–™è¡¨å·²å»ºç«‹**ï¼š
   - å‰å¾€ Supabase Dashboard
   - æª¢æŸ¥æ˜¯å¦æœ‰ `forms`ã€`orders`ã€`settings` ä¸‰å€‹è³‡æ–™è¡¨

### å¦‚ä½•ç¢ºèªè³‡æ–™æ˜¯å¦å¯«å…¥ Supabaseï¼Ÿ

#### æ–¹æ³• 1ï¼šåœ¨ Supabase Dashboard æŸ¥çœ‹

1. **å‰å¾€ Supabase Dashboard**
   - ç¶²å€ï¼šhttps://supabase.com/dashboard
   - ç™»å…¥æ‚¨çš„å¸³è™Ÿ

2. **é¸æ“‡æ‚¨çš„å°ˆæ¡ˆ**

3. **é»æ“Šå·¦å´é¸å–®çš„ "Table Editor"**

4. **é¸æ“‡ `orders` è³‡æ–™è¡¨**

5. **æŸ¥çœ‹è¨‚å–®è³‡æ–™**
   - å¦‚æœå®¢æˆ¶ä¸‹å–®å¾Œï¼Œé€™è£¡æ‡‰è©²æœƒå‡ºç¾æ–°çš„è¨‚å–®è¨˜éŒ„

#### æ–¹æ³• 2ï¼šæ¸¬è©¦ä¸‹å–®

1. **å‰µå»ºä¸€å€‹æ¸¬è©¦è¡¨å–®**
   - è¨­å®šç°¡å–®çš„æ¬„ä½
   - å–å¾—è¡¨å–®é€£çµ

2. **å¡«å¯«ä¸¦é€å‡ºè¨‚å–®**

3. **ç«‹å³æª¢æŸ¥ Supabase Dashboard**
   - æ‡‰è©²æœƒçœ‹åˆ°æ–°çš„è¨‚å–®è¨˜éŒ„

## ğŸ¯ é‡è¦èªªæ˜

### âœ… å¦‚æœè¨­å®šç‚º Supabase

- **è³‡æ–™æœƒç›´æ¥å¯«å…¥é›²ç«¯**
- **ä¸éœ€è¦æ‚¨çš„é›»è…¦ IP**
- **å¯ä»¥å¾ä»»ä½•åœ°æ–¹å­˜å–**
- **è³‡æ–™å®‰å…¨å‚™ä»½åœ¨é›²ç«¯**

### âŒ å¦‚æœè¨­å®šç‚º SQLite

- **è³‡æ–™æœƒå¯«å…¥æœ¬åœ°æª”æ¡ˆ** (`orders.db`)
- **åªæœ‰æ‚¨çš„é›»è…¦å¯ä»¥å­˜å–**
- **éœ€è¦å‚™ä»½æœ¬åœ°æª”æ¡ˆ**

## ğŸ”„ è³‡æ–™åŒæ­¥

### è¡¨å–®å‰µå»º

```
æ‚¨å‰µå»ºè¡¨å–®
  â†“
å¯«å…¥ Supabase (forms è¡¨)
  â†“
ç”Ÿæˆé€£çµå’Œ QR Code
  â†“
åˆ†äº«çµ¦å®¢æˆ¶
```

### å®¢æˆ¶ä¸‹å–®

```
å®¢æˆ¶å¡«å¯«è¡¨å–®
  â†“
é»æ“Šã€Œé€å‡ºã€
  â†“
API è™•ç†
  â†“
å¯«å…¥ Supabase (orders è¡¨) âœ…
  â†“
è³‡æ–™ç«‹å³åœ¨é›²ç«¯å¯ç”¨
```

### æ‚¨æŸ¥çœ‹è¨‚å–®

```
æ‚¨æ‰“é–‹ç®¡ç†é é¢
  â†“
API å¾ Supabase è®€å–è¨‚å–®
  â†“
é¡¯ç¤ºåœ¨ç¶²é ä¸Š
```

## ğŸ“Š è³‡æ–™åº«çµæ§‹

### Supabase ä¸­çš„è³‡æ–™è¡¨

```sql
-- è¡¨å–®è¡¨
forms (
  id, name, fields, deadline, form_token, ...
)

-- è¨‚å–®è¡¨ï¼ˆå®¢æˆ¶ä¸‹å–®çš„è³‡æ–™æœƒå¯«å…¥é€™è£¡ï¼‰
orders (
  id,
  form_id,              -- é—œè¯åˆ°å“ªå€‹è¡¨å–®
  customer_name,        -- å®¢æˆ¶å§“å
  customer_phone,       -- å®¢æˆ¶é›»è©±
  order_data,           -- è¨‚å–®è©³ç´°è³‡æ–™ï¼ˆJSONï¼‰
  order_token,          -- è¨‚å–®ä»£ç¢¼
  created_at,           -- å»ºç«‹æ™‚é–“
  ...
)
```

## âœ… ç¸½çµ

### å•é¡Œï¼šå®¢æˆ¶ä¸‹å–®å¾Œï¼Œè³‡æ–™æœƒè·‘åˆ°é›²ç«¯è³‡æ–™åº«å—ï¼Ÿ

**ç­”æ¡ˆï¼šæ˜¯çš„ï¼** å¦‚æœæ‚¨çš„ç³»çµ±è¨­å®šç‚ºä½¿ç”¨ Supabaseï¼š

1. âœ… **å®¢æˆ¶ä¸‹å–®** â†’ è³‡æ–™ç«‹å³å¯«å…¥ Supabase é›²ç«¯è³‡æ–™åº«
2. âœ… **ä¸éœ€è¦æ‚¨çš„é›»è…¦ IP** â†’ è³‡æ–™ç›´æ¥å¯«å…¥é›²ç«¯
3. âœ… **å¯ä»¥å¾ä»»ä½•åœ°æ–¹æŸ¥çœ‹** â†’ åªè¦ç™»å…¥ Supabase Dashboard
4. âœ… **è³‡æ–™å®‰å…¨å‚™ä»½** â†’ åœ¨ Supabase é›²ç«¯ä¼ºæœå™¨

### å¦‚ä½•ç¢ºèªï¼Ÿ

1. **æª¢æŸ¥ `.env.local`**ï¼šç¢ºèª `DATABASE_TYPE=supabase`
2. **æ¸¬è©¦ä¸‹å–®**ï¼šå‰µå»ºæ¸¬è©¦è¡¨å–®ï¼Œå¡«å¯«ä¸¦é€å‡º
3. **æŸ¥çœ‹ Supabase Dashboard**ï¼šæ‡‰è©²æœƒçœ‹åˆ°æ–°çš„è¨‚å–®è¨˜éŒ„

### å¦‚æœæ²’æœ‰çœ‹åˆ°è³‡æ–™ï¼Ÿ

å¯èƒ½çš„åŸå› ï¼š
1. âš ï¸ è¨­å®šç‚º SQLite è€Œä¸æ˜¯ Supabase
2. âš ï¸ Supabase è¨­å®šä¸æ­£ç¢º
3. âš ï¸ Supabase è³‡æ–™è¡¨å°šæœªå»ºç«‹

éœ€è¦æˆ‘å”åŠ©æ‚¨ç¢ºèªè¨­å®šå—ï¼Ÿ

